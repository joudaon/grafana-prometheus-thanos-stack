#!/bin/bash

set -euo pipefail

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸŽ¯ Initial configuration
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CLUSTER_MASTER="master"
CLUSTER_SLAVE="slave"
KUBECONFIG_SLAVE="slave-kubeconfig.yaml"
ARGOCD_VERSION="7.8.16"
ARGOCD_DOMAIN="argocd.myorg.com"
GRAFANA_DOMAIN="grafana.myorg.com"
PROMETHEUS_DOMAIN="prometheus.myorg.com"
ARGOCD_PORT="8443"
CREDENTIALS_FILE="credentials.txt"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ§¹ Delete existing clusters (if any)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ðŸ§¹ Deleting existing clusters (if any)..."
kind delete clusters -A || true

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ”§ Create master and slave clusters
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ðŸ› ï¸ Creating '$CLUSTER_MASTER' cluster..."
kind create cluster --config clusters/kind-${CLUSTER_MASTER}.yaml

echo "ðŸ› ï¸ Creating '$CLUSTER_SLAVE' cluster..."
kind create cluster --config clusters/kind-${CLUSTER_SLAVE}.yaml

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸš€ Install Nginx Ingress and MetalLB controllers
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ðŸš€ Installing Nginx Ingress in '$CLUSTER_MASTER'..."
kubectl config use-context kind-${CLUSTER_MASTER}
kubectl apply -f deploy-ingress-nginx.yaml
sleep 20s
kubectl apply -f metallb/my-metallb.yaml
sleep 20s
kubectl apply -f metallb/metallb-config-master.yaml
sleep 5s

echo "ðŸš€ Installing Nginx Ingress in '$CLUSTER_SLAVE'..."
kubectl config use-context kind-${CLUSTER_SLAVE}
kubectl apply -f deploy-ingress-nginx.yaml
sleep 20s
kubectl apply -f metallb/my-metallb.yaml
sleep 20s
kubectl apply -f metallb/metallb-config-slave.yaml
sleep 5s

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸš€ Install ArgoCD in the master cluster
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ðŸš€ Installing ArgoCD in '$CLUSTER_MASTER'..."
kubectl config use-context kind-${CLUSTER_MASTER}
helm repo add argo https://argoproj.github.io/argo-helm
helm repo update
helm install argocd argo/argo-cd \
  -f argocd_values.yaml \
  --namespace argocd \
  --version $ARGOCD_VERSION \
  --create-namespace \
  --wait

# Give it a bit of time to settle
echo "â± Waiting a bit for ArgoCD components to fully initialize..."
sleep 5s

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ” Login to ArgoCD
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ðŸ” Logging into ArgoCD..."
ARGOCD_PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
argocd login ${ARGOCD_DOMAIN}:${ARGOCD_PORT} --username admin --password $ARGOCD_PASSWORD --insecure --grpc-web

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ”— Register the slave cluster in ArgoCD
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ðŸ”— Registering '$CLUSTER_SLAVE' cluster in ArgoCD..."

echo "ðŸ“¦ Exporting kubeconfig for '$CLUSTER_SLAVE'..."
kind export kubeconfig --name "$CLUSTER_SLAVE" --kubeconfig "$KUBECONFIG_SLAVE"

echo "ðŸ” Getting Docker IP of ${CLUSTER_SLAVE}-control-plane..."
CONTAINER_NAME="${CLUSTER_SLAVE}-control-plane"
CONTAINER_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' "$CONTAINER_NAME")

if [[ -z "$CONTAINER_IP" ]]; then
  echo "âŒ Could not get container IP for $CONTAINER_NAME"
  exit 1
fi

echo "âœï¸ Patching kubeconfig to use IP $CONTAINER_IP..."
sed -i.bak -E "s|https://127.0.0.1:[0-9]+|https://${CONTAINER_IP}:6443|" "$KUBECONFIG_SLAVE"

echo "ðŸš€ Adding '$CLUSTER_SLAVE' to ArgoCD..."
argocd cluster add --kubeconfig "$KUBECONFIG_SLAVE" kind-${CLUSTER_SLAVE} -y

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âœ… Wrap-up
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "âœ… Clusters and applications deployed successfully!"
echo ""
echo "ðŸŒ Access your services:"
echo "  â–¶ HTTP  (master) : http://localhost:8080/"
echo "  â–¶ HTTPS (master) : https://localhost:8443/"
echo "  â–¶ HTTP  (slave)  : http://localhost:8081/"
echo "  â–¶ HTTPS (slave)  : https://localhost:8444/"
echo "  â–¶ ArgoCD         : https://${ARGOCD_DOMAIN}:${ARGOCD_PORT}/"
echo "  â–¶ Grafana        : https://${GRAFANA_DOMAIN}:${ARGOCD_PORT}/"
echo "  â–¶ Prometheus     : https://${PROMETHEUS_DOMAIN}:8444/"
echo ""

echo "ðŸ’¾ Saving ArgoCD / Grafana credentials to '${CREDENTIALS_FILE}'..."
rm -f $CREDENTIALS_FILE
{
  echo "ArgoCD URL       --> https://${ARGOCD_DOMAIN}:${ARGOCD_PORT}/"
  echo "ArgoCD User      --> admin"
  echo "ArgoCD Password  --> $ARGOCD_PASSWORD"
  echo "Grafana User     --> admin"
  echo "Grafana Password --> $> kubectl get secret grafana -n monitoring -o jsonpath="{.data.admin-password}" | base64 -d"
} >> $CREDENTIALS_FILE
